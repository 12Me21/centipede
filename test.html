<!doctype html>

<svg xmlns=http://www.w3.org/2000/svg viewBox="0 0 900 900" width=900>
	<style>
		.chip rect {
			fill: beige;
			stroke: maroon;
			stroke-width: 2px;
		}
		.chip text {
			dominant-baseline: central;
			font-size: 7px;
			fill: black;
			font-family: ms pmincho;
		}
		.chip path {
			stroke: maroon;
			stroke-width: 2px;
			stroke-linecap: round;
		}
		.r {
			text-anchor: end;
		}
		.ol {
			text-decoration: overline;
		}
		.chip .name {
			dominant-baseline: auto;
			text-anchor: middle;
		}
	</style>
	<!--<g stroke=green stroke-width=1px fill=none>
		<path d="m270,110 v-20 h50 v20"/>
		<path d="m210,110 v-20 h50 v20 m0,10 h10"/>
		<path d="m200,120 h10"/>
	</g>
	<g class=chip>
		<text x=235 y=98 class=name>IC19:1</text>
		<rect x=220 y=100 width=30 height=50 />
		<path d="m220,110 h-10" /><text x=222 y=110>D</text>
		<path d="m220,120 h-10" /><text x=222 y=120>CLK</text>
		<path d="m220,130 h-10" /><text x=222 y=130>~RES</text>
		<path d="m220,140 h-10" /><text x=222 y=140>~CLR</text>
		<path d="m250,110 h10" /><text x=248 y=110 class=r>~Q</text>
		<path d="m250,120 h10" /><text x=248 y=120 class=r>Q</text>
	</g>
	<g class=chip>
		<text x=295 y=98 class=name>IC19:2</text>
		<rect x=280 y=100 width=30 height=50 />
		<path d="m280,110 h-10" /><text x=282 y=110>D</text>
		<path d="m280,120 h-10" /><text x=282 y=120>CLK</text>
		<path d="m280,130 h-10" /><text x=282 y=130>~RES</text>
		<path d="m280,140 h-10" /><text x=282 y=140>~CLR</text>
		<path d="m310,110 h10" /><text x=308 y=110 class=r>~Q</text>
		<path d="m310,120 h10" /><text x=308 y=120 class=r>Q</text>
	</g>
	<g class=chip>
		<text x=175 y=108 class=name>X3 26.686MHz</text>
		<rect x=160 y=110 width=30 height=20 />
		<path d="m190,120 h10" /><text x=188 y=120 class=r>CLK</text>
	</g>-->
	<g id=$dest>
	</g>
</svg>

<script>
	function calculate_pin_position(symbol, pin) {
		pin.r = {
			x: [pin.slot,symbol.width,symbol.width-pin.slot,0][pin.side],
			y: [0,pin.slot,symbol.height,symbol.height-pin.slot][pin.side],
			dir: ["v-10","h10","v10","h-10"][pin.side],
			diro: ["h-1l1,-1l1,1h-1v-10","v-3l3,3l-3,3v-3 h10","v10","h-10"][pin.side],
		}
		pin.e = {
			x: pin.r.x + [0,1,0,-1][pin.side],
			y: pin.r.y + [-1,0,1,0][pin.side],
		}
	}
	
	class Component {
		constructor(obj) {
			let x = Object.setPrototypeOf(obj, Component.prototype)
			for (let pin of x.pins) {
				calculate_pin_position(x, pin)
			}
			return x
		}
	}
	
	let d = new Component({
		width: 3,
		height: 5,
		name: "74F74",
		pins: [
			{name:"D", num: 2, side:3, slot:4},
			{name:"CLK", num: 3, side:3, slot:3},
			{name:"~PRE", num: 4, side:3, slot:2},
			{name:"~CLR", num: 1, side:3, slot:1},
			{name:"~Q", num: 6, side:1, slot:1, out:1},
			{name:"Q", num: 5, side:1, slot:2, out:1},
		],
	})
	let f04 = new Component({
		width: 3,
		height: 7,
		name: "74F04",
		pins: [
			{name:"I1", num:1, side:3, slot:6},
			{name:"I2", num:3, side:3, slot:5},
			{name:"I3", num:5, side:3, slot:4},
			{name:"I4", num:9, side:3, slot:3},
			{name:"I5", num:11, side:3, slot:2},
			{name:"I6", num:13, side:3, slot:1},
			{name:"Y1", num:2, side:1, slot:1,out:1},
			{name:"Y2", num:4, side:1, slot:2,out:1},
			{name:"Y3", num:6, side:1, slot:3,out:1},
			{name:"Y4", num:9, side:1, slot:4,out:1},
			{name:"Y5", num:10, side:1, slot:5,out:1},
			{name:"Y6", num:12, side:1, slot:6,out:1},
		],
	})
	let osc = new Component({
		width:3,
		height: 2,
		name:"oscillator",
		pins: [
			{name:"CLK",side:1,slot:1,out:1},
		],
	})
	let oscpkg = { //hm.
		symbol: osc,
		pads: {
			"CLK": 8,
			"VCC": 14,
			"GND": 7,
		}
	}
	
	let placed = [
		/*{
			name: "IC19:A",
			symbol: d,
			pos: {x:22, y:10},
		},
		{
			name: "IC19:B",
			symbol: d,
			pos: {x:28, y:10},
		},
		{
			name: "X1",
			symbol: osc,
			pos: {x:16, y:11},
		},*/
		{
			name: "IC64",
			symbol: d,
			pos: {x:10, y:11},
		},
		{
			name: "IC65",
			symbol: f04,
			pos: {x:16, y:11},
		},
	]
	let cons = [
		[["IC65.13", null], "h-20"],
		[["IC65.12", "IC64.3"], ""],
		
		/*[["IC19:A.D", "IC19:A.~Q"], "v-20 h50"],
		[["IC19:B.D", "IC19:B.~Q"], "v-20 h50"],
		[["IC19:A.Q", "IC19:B.CLK"], ""],
		[["IC19:A.~PRE", "IC19:A.~CLR"], ""],
		[["IC19:B.~PRE", "IC19:B.~CLR"], ""],
		[["IC19:A.Q", null], "v40 h100"],
		[["IC19:B.Q", null], "h40"],
		[["X1.CLK", "IC19:A.CLK"], ""],*/
	]
	let byname = {}
	for (let p of placed)
		byname[p.name] = p
	
	function generate_symbol({name, symbol:def, pos:{x, y}}) {
		let s = ''
		let {width, height} = def
		s += `<g class=chip>`
		s += `<text x=${(x+width/2)*10} y=${(y-0.2)*10} class=name >${name}</text>`
		s += `<rect x=${(x)*10} y=${(y)*10} width=${(width)*10} height=${(height)*10} />`
		for (let p of def.pins) {
			let px = x + p.r.x
			let py = y + p.r.y
			let dir = p.out ? p.r.diro : p.r.dir
			s += `<path d="m${(px)*10},${(py)*10} ${dir}" />`
			if (p.side==0)
				s += `<text transform="translate(${(px)*10} ${(py+0.2)*10}) rotate(90)">${p.name}</text>`
			if (p.side==1)
				s += `<text x=${(px-0.2)*10} y=${(py)*10} text-anchor=end>${p.name}</text>`
			if (p.side==2)
				s += `<text transform="translate(${(px)*10} ${(py-0.2)*10}) rotate(-90)">${p.name}</text>`
			if (p.side==3)
				s += `<text x=${(px+0.2)*10} y=${(py)*10}>${p.name}</text>`
		}
		return s + "</g>"
	}
	function lookup_pin(des) {
		let [part,pin] = des.split(".")
		part = byname[part]
		pin = part.symbol.pins.find(x=>(x.num==pin||x.name==pin))
		return [part, pin]
	}
	function draw_conn([pins, path]) {
		let [part, pin] = lookup_pin(pins[0])
		let s = ''
		s += `m${[(pin.e.x+part.pos.x)*10,(pin.e.y+part.pos.y)*10]} `
		s += path
		if (pins[1]) {
			0,[part, pin] = lookup_pin(pins[1])
			s += ` L${[(pin.e.x+part.pos.x)*10,(pin.e.y+part.pos.y)*10]}`
		}
		return `<path d="`+s+`"/>`
	}
	
	let s = ''
	s += "<g stroke=green stroke-width=1px fill=none>"
	for (let conn of cons) {
		s += draw_conn(conn)
	}
	s += "</g>"
	for (let p of placed) {
		byname[p.name] = p
		s += generate_symbol(p)
	}
	$dest.innerHTML = s
</script>
