<!doctype html>

<svg xmlns=http://www.w3.org/2000/svg viewBox="0 0 500 500" width=1000>
	<style>
		@font-face {
			font-family: 'mspm';
			src: url("./short2.otf?1");
		}
		
		.chip rect {
			fill: beige;
			stroke: maroon;
			stroke-width: 2px;
		}
		.chip text {
			dominant-baseline: central;
			font-size: 7px;
			fill: black;
			font-family: ms pmincho;
		}
		.chip path {
			stroke: maroon;
			stroke-width: 2px;
			stroke-linecap: round;
		}
		.r {
			text-anchor: end;
		}
		.ol {
			text-decoration: overline;
		}
		.chip .name {
			dominant-baseline: auto;
			text-anchor: middle;
			font-size: 8px;
			font-weight: bold;
		}
		.chip .desc {
			dominant-baseline: auto;
			text-anchor: middle;
			font-size: 6px;
		}
		.chip .num {
			dominant-baseline: auto;
			font-size: 6px;
			fill: #008;
		}
		.net.net {
			stroke: none;
			fill: blue;
			font-size: 8px;
			dominant-baseline: central;
			font-family: ms pmincho
		}
		.overline {
			text-decoration: underline;
			text-underline-offset: -6px;
			text-decoration-skip-ink: none;
			text-underline-position: from-font;
		}
		.crossing {
			fill: white;
			stroke: none;
		}
	</style>
	<g id=$dest>
	</g>
</svg>

<script>
	function calculate_pin_position(symbol, pin) {
		pin.r = {
			x: [pin.slot,symbol.width,symbol.width-pin.slot,0][pin.side],
			y: [0,pin.slot,symbol.height,symbol.height-pin.slot][pin.side],
			dir: ["v-10","h10","v10","h-10"][pin.side],
			diro: ["h-1l1,-1l1,1h-1v-10","v-3l3,3l-3,3v-3 h10","v10","h-10"][pin.side],
		}
		pin.e = {
			x: pin.r.x + [0,1,0,-1][pin.side],
			y: pin.r.y + [-1,0,1,0][pin.side],
		}
	}
	
	class Component {
		constructor(obj) {
			let x = Object.setPrototypeOf(obj, Component.prototype)
			for (let pin of x.pins) {
				calculate_pin_position(x, pin)
			}
			return x
		}
	}
	
	let d = new Component({
		width: 3,
		height: 5,
		name: "74F74",
		desc: "d-flip-flop",
		pins: [
			{name:"D", num: 2, side:3, slot:4},
			{name:"CLK", num: 3, side:3, slot:3},
			{name:"~PRE", num: 4, side:3, slot:2},
			{name:"~CLR", num: 1, side:3, slot:1},
			{name:"~Q", num: 6, side:1, slot:1, out:1},
			{name:"Q", num: 5, side:1, slot:2, out:1},
		],
	})
	let f161 = new Component({
		width: 4,
		height: 12,
		name: "74F161",
		desc: "binary counter",
		pins: [
			{name:"D0", num: 3, side:3, slot:11},
			{name:"D1", num: 4, side:3, slot:10},
			{name:"D2", num: 5, side:3, slot:9},
			{name:"D3", num: 6, side:3, slot:8},
			{name:"~LOAD", num: 9, side:3, slot:6},
			{name:"ENP", num: 7, side:3, slot:5},
			{name:"ENT", num: 10, side:3, slot:4},
			{name:"CLK", num: 2, side:3, slot:3},
			{name:"~MR", num: 1, side:3, slot:1},
			
			{name:"Q0", num: 14, side:1, slot:1},
			{name:"Q1", num: 13, side:1, slot:2},
			{name:"Q2", num: 12, side:1, slot:3},
			{name:"Q3", num: 11, side:1, slot:4},
			{name:"RCO", num: 15, side:1, slot:10},
		],
	})
	let d2 = new Component({
		width: 3,
		height: 5,
		name: "74F74",
		desc: "(cont.)",
		pins: [
			{name:"D", num: 12, side:3, slot:4},
			{name:"CLK", num: 11, side:3, slot:3},
			{name:"~PRE", num: 10, side:3, slot:2},
			{name:"~CLR", num: 13, side:3, slot:1},
			{name:"~Q", num: 8, side:1, slot:1, out:1},
			{name:"Q", num: 9, side:1, slot:2, out:1},
		],
	})
	let dpram = new Component({
		width: 4,
		height: 16,
		name: "MB8421 L",
		desc: "dual-port RAM",
		pins: [
			{name:"~BUSY", num: 3, side:1, slot:12},
			{name:"~INT", num: 4, side:1, slot:13},
			{name:"IO0", num: 18, side:1, slot:1},
			{name:"IO1", num: 19, side:1, slot:2},
			{name:"IO2", num: 20, side:1, slot:3},
			{name:"IO3", num: 21, side:1, slot:4},
			{name:"IO4", num: 22, side:1, slot:5},
			{name:"IO5", num: 23, side:1, slot:6},
			{name:"IO6", num: 24, side:1, slot:7},
			{name:"IO7", num: 25, side:1, slot:8},
			
			{name:"~CS", num: 1, side:3, slot:3},
			{name:"~WE", num: 2, side:3, slot:2},
			{name:"~OE", num: 7, side:3, slot:1},
			{name:"A0", num: 8, side:3, slot:15},
			{name:"A1", num: 9, side:3, slot:14},
			{name:"A2", num: 10, side:3, slot:13},
			{name:"A3", num: 11, side:3, slot:12},
			{name:"A4", num: 12, side:3, slot:11},
			{name:"A5", num: 13, side:3, slot:10},
			{name:"A6", num: 14, side:3, slot:9},
			{name:"A7", num: 15, side:3, slot:8},
			{name:"A8", num: 16, side:3, slot:7},
			{name:"A9", num: 17, side:3, slot:6},
			{name:"A10", num: 6, side:3, slot:5},
		],
	})
	let f04 = new Component({
		width: 3,
		height: 7,
		name: "74F04",
		desc: "inverter",
		pins: [
			{name:"I1", num:1, side:3, slot:1},
			{name:"I2", num:3, side:3, slot:2},
			{name:"I3", num:5, side:3, slot:3},
			{name:"I4", num:9, side:3, slot:4},
			{name:"I5", num:11, side:3, slot:5},
			{name:"I6", num:13, side:3, slot:6},
			{name:"~Y1", num:2, side:1, slot:6,out:1},
			{name:"~Y2", num:4, side:1, slot:5,out:1},
			{name:"~Y3", num:6, side:1, slot:4,out:1},
			{name:"~Y4", num:9, side:1, slot:3,out:1},
			{name:"~Y5", num:10, side:1, slot:2,out:1},
			{name:"~Y6", num:12, side:1, slot:1,out:1},
		],
	})
	let osc = new Component({
		width:3,
		height: 2,
		name:"oscillator",
		pins: [
			{name:"CLK",side:1,slot:1,out:1},
		],
	})
	let oscpkg = { //hm.
		symbol: osc,
		pads: {
			"CLK": 8,
			"VCC": 14,
			"GND": 7,
		}
	}
	
	let placed = [
		{
			name: "IC21A",
			displayname: "IC21:1",
			symbol: d,
			pos: {x:12-5, y:11},
		},
		{
			name: "IC21B",
			displayname: "IC21:2",
			symbol: d2,
			pos: {x:19-5, y:11},
		},
		{
			name: "IC22",
			symbol: f161,
			pos: {x:30-3-5, y:11-5},
		},
		{
			name: "IC30L",
			displayname: "IC30:L",
			symbol: dpram,
			pos: {x:35-5, y:10-5},
		},
	]
	let cons = [
		[["IC22.D0", "IC22.D1"], ""],
		[["IC22.D1", "IC22.D2"], ""],
		[["IC22.D2", "IC22.D3"], ""],
		[["IC22.D3", "GND"], ""],
		
		[["IC22.~LOAD", "VCC"], ""],
		[["IC22.RCO", "NC"], ""],
		
		[["IC22.ENP", "IC22.ENT"], ""],
		
		[["IC21A.D", "IC21A.~Q"], "v-30 h50"],
		[["IC21B.D", "IC21B.~Q"], "v-30 h50"],
		[["IC21A.Q", "IC21B.CLK"], ""],
		[["IC21A.Q", "IC22.CLK"], "h10 v50 h70 v-30"],
		[["IC21B.Q", "IC30L.A0"], "h20 v-90 h80 v20"],
		[["IC22.Q0", "IC30L.A1"], ""],
		[["IC22.Q1", "IC30L.A2"], ""],
		[["IC22.Q2", "IC30L.A3"], ""],
		[["IC22.Q3", "IC30L.A4"], ""],
		[["IC21A.CLK", "=OTIS.E"], ""],
		
		[["IC21A.~PRE", "GND"], ""],
		[["IC21B.~PRE", "GND"], ""],
		"<circle cx=120 cy=170 r=1.5 class=crossing />",
		"<circle cx=190 cy=170 r=1.5 class=crossing />",
		[["IC21A.~CLR", "IC21B.~CLR"], "v20 h70"],
		[["IC21B.~CLR", "IC22.~MR"], "v20"],
		[["IC21A.~CLR", "=OTIS.BS"], ""],
		[["IC21B.Q", "IC22.ENP"], ""],
		
		[["IC30L.A5", "IC30L.A6"], ""],
		[["IC30L.A6", "IC30L.A7"], ""],
		[["IC30L.A7", "IC30L.A8"], ""],
		[["IC30L.A8", "IC30L.A9"], ""],
		[["IC30L.A9", "IC30L.A10"], ""],
		[["IC30L.A10", "GND"], ""],
		
		[["IC30L.IO4", "NC"], ""],
		[["IC30L.IO5", "NC"], ""],
		[["IC30L.IO6", "NC"], ""],
		[["IC30L.IO7", "NC"], ""],
		[["IC30L.IO0", "=cartB.89"], ""],
		[["IC30L.IO1", "=cartB.90"], ""],
		[["IC30L.IO2", "=cartB.91"], ""],
		[["IC30L.IO3", "=cartB.92"], ""],
		
		[["IC30L.~OE", "GND"], ""],
		
		[["IC30L.~BUSY", "IC30L.~WE"], "h10 v50 h-80 v-30"], // unsure
	]
	let byname = {}
	for (let p of placed)
		byname[p.name] = p
	
	function generate_symbol({name, displayname, suffix="", symbol:def, pos:{x, y}}) {
		let s = ''
		let {width, height} = def
		s += `<g class=chip>`
		s += `<text x=${(x+width/2)*10} y=${(y-0.8)*10} class=name >${displayname || name}${suffix}</text>`
		s += `<text x=${(x+width/2)*10} y=${(y-0.2)*10} class=desc >${def.name} ${def.desc}</text>`
		s += `<rect x=${(x)*10} y=${(y)*10} width=${(width)*10} height=${(height)*10} />`
		for (let p of def.pins) {
			let px = x + p.r.x
			let py = y + p.r.y
			//let dir = p.out ? p.r.diro : p.r.dir
			let dir = p.r.dir
			s += `<path d="m${(px)*10},${(py)*10} ${dir}" />`
			let pname = p.name
			let ext = ""
			if (pname[0]=="~") {
				//pname = pname.slice(1)
				//ext = "class=overline"
			}
			pname += suffix
			if (p.side==0) {
				s += `<text transform="translate(${(px)*10} ${(py+0.2)*10}) rotate(90)">${p.name}</text>`
			} if (p.side==1) {
				s += `<text x=${(px-0.2)*10} y=${(py)*10} text-anchor=end ${ext}>${pname}</text>`
				s += `<text x=${(px+0.2)*10} y=${(py-0.2)*10} class=num>${p.num}</text>`
			} if (p.side==2) {
				s += `<text transform="translate(${(px)*10} ${(py-0.2)*10}) rotate(-90)">${p.name}</text>`
			} if (p.side==3) {
				s += `<text x=${(px+0.2)*10} y=${(py)*10} ${ext}>${pname}</text>`
				s += `<text x=${(px-0.2)*10} y=${(py-0.2)*10} text-anchor=end class=num>${p.num}</text>`
			}
		}
		return s + "</g>"
	}
	function lookup_pin(des) {
		let [part,pin] = des.split(".")
		part = byname[part]
		pin = part.symbol.pins.find(x=>(x.num==pin||x.name==pin))
		return [part, pin]
	}
	function draw_conn([pins, path]) {
		let [part, pin] = lookup_pin(pins[0])
		let s = ''
		s += `m${[(pin.e.x+part.pos.x)*10,(pin.e.y+part.pos.y)*10]} `
		s += path
		let s2 = ""
		if (pins[1]) {
			if (pins[1]=="VCC") {
				s += `v-3 h-1 l1,-3 l1,3 h-1 v-3`
			} else if (pins[1]=="GND") {
				s += `v3 h-3 l3,3 l3,-3 h-3`
			} else if (pins[1]=="NC") {
				s += `m-2,-2 l4,4 m0-4 l-4,4`
			} else if (pins[1][0]=="=") {
				if (pin.side==3)
					s2 = `<text x=${(pin.e.x+part.pos.x-0.2)*10} y=${(pin.e.y+part.pos.y)*10} class=net text-anchor=end>${pins[1].slice(1)}</text>`
				else 
					s2 = `<text x=${(pin.e.x+part.pos.x+0.2)*10} y=${(pin.e.y+part.pos.y)*10} class=net text-anchor=start>${pins[1].slice(1)}</text>`
			} else {
				0,[part, pin] = lookup_pin(pins[1])
				s += ` L${[(pin.e.x+part.pos.x)*10,(pin.e.y+part.pos.y)*10]}`
			}
		}
		return `<path d="`+s+`"/>`+s2
	}
	
	let s = ''
	for (let p of placed) {
		byname[p.name] = p
		s += generate_symbol(p)
	}
	s += "<g stroke=green stroke-width=1px fill=none>"
	for (let conn of cons) {
		if ('string'==typeof conn)
			s += conn
		else
			s += draw_conn(conn)
	}
	s += "</g>"
	$dest.innerHTML = s
</script>
