<!doctype html><meta charset=utf-8>

<svg xmlns=http://www.w3.org/2000/svg viewBox="-10 0 1000 3000" width=1000>
	<style>
		@font-face {
			font-family: 'mspm';
			src: url("./short2.otf?1");
		}
		:root {
			font-family: mspm, serif;
		}
		.title {
			font-size: 24px;
			text-decoration: underline;
		}
		.l { text-anchor: start; }
		.c { text-anchor: middle; }
		.r { text-anchor: end; }
		.t { dominant-baseline: hanging; }
		.m { dominant-baseline: central; }
		.b { dominant-baseline: auto; }
		.cb {
			fill: beige;
			stroke: maroon;
			stroke-width: 4px;
		}
		.db {
			fill: none;
			stroke-width: 2px;
			stroke: maroon;
		}
		.pp {
			stroke: maroon;
			stroke-width: 4px;
			stroke-linecap: round;
		}
		.cn {
			font-size: 16px;
			font-weight: bold;
		}
		.dn {
			font-size: 14px;
			font-weight: bold;
		}
		.cd {
			font-size: 12px;
		}
		.pl {
			font-size: 14px;
			fill: black;
		}
		.pn {
			font-size: 12px;
			fill: #008;
		}
		.nl {
			stroke: none;
			fill: blue;
			font-size: 16px;
		}
		.ns {
			stroke: blue;
			fill: none;
			stroke-width: 2px;
		}
		.overline {
			text-decoration: underline;
			text-underline-offset: -12px;
			text-decoration-skip-ink: none;
			text-underline-position: from-font;
		}
		/*.net:hover path {
			stroke: red;
		}
		.net:hover text {
			fill: red;
		}
		.net:hover .junction {
			fill: red;
		}*/
		.ww path {
			fill: none;
			stroke-width: 2px;
			stroke-linecap: round;
			stroke: green;
		}
		.ww circle {
			fill: white;
			stroke: none;
		}
		.wj {
			fill: green;
			stroke: none;
		}
	</style>
	<g id=$dest>
	</g>
</svg>

<script src=lib.js></script>
<script src=components.js></script>
<script src=placed.js></script>
<script>
	let groups = {}
	function output(g, str) {
		if (!groups[g])
			groups[g] = ''
		groups[g] += str
	}
	for (let p of placed) {
		byname[p.name] = p
		// hack:
		let sheet = sheets[p.sheet]
		if (sheet) {
			p.pos.x += sheet.pos.x
			p.pos.y += sheet.pos.y
		}
	}
	let cons2 = cons.split("\n").map(x=>x.split("#",1)[0].trim()).filter(x=>x)
	
	for (let conn of cons2) {
		draw_conn2(conn)
	}
	for (let p of placed) {
		if (!p.symbol) {
			output("chiplabel", `<text class="title" ${attrxy(p.pos.x, p.pos.y)}>${p.displayname}</text>`)
		} else
			p.symbol.render(p)
	}
	// todo: ok we can simplify our css now, right?
	// though we do need to restore some of the grouping info (e.g. which pins belong to which chip) now that we now longer store that via tree structure
	for (let g in groups) 
		console.log(g, groups[g].length)
	let s = `
<g id='compbody' class='cb'>${groups.compbody}</g>
<g id='compdetail' class='db'>${groups.compdetail}</g>

<g id='wires' class='ww'>${groups.wires}</g>
<g id='junctions' class='wj'>${groups.junctions}</g>

<path id='pin' class='pp' d="${groups.pin}"/>

<g id='chiplabel'>${groups.chiplabel}</g>

<g id='netlabels'>${groups.netlabels}</g>
`
	$dest.innerHTML = s
	console.log("size:",s.length)
</script>
<canvas id=$c width=200 height=200></canvas>
<script>
	let c = $c.getContext('2d')
	let id = c.getImageData(0,0,200,200)
	let dd = new Int32Array(id.data.buffer)
	for (let k=0;k<hitmap.length;k++) {
		if (hitmap[k])
			dd[k] = 0xFF0000FF
	}
	c.putImageData(id,0,0)
</script>
