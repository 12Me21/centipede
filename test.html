<!doctype html><meta charset=utf-8>

<svg xmlns=http://www.w3.org/2000/svg viewBox="-10 0 1000 2000" width=1000>
	<style>
		@font-face {
			font-family: 'mspm';
			src: url("./short2.otf?1");
		}
		.l { text-anchor: start; }
		.c { text-anchor: middle; }
		.r { text-anchor: end; }
		.t { dominant-baseline: hanging; }
		.m { dominant-baseline: central; }
		.b { dominant-baseline: auto; }
		.body {
			fill: beige;
			stroke: maroon;
			stroke-width: 4px;
		}
		.pin {
			stroke: maroon;
			stroke-width: 4px;
			stroke-linecap: round;
		}
		.name {
			font-size: 16px;
			font-weight: bold;
		}
		.desc {
			font-size: 12px;
		}
		.resistor .name {
			font-size: 14px;
		}
		.resistor .desc {
		}
		.pname {
			font-size: 14px;
			fill: black;
		}
		.num {
			font-size: 12px;
			fill: #008;
		}
		.netlabel {
			stroke: none;
			fill: blue;
			font-size: 16px;
		}
		.overline {
			text-decoration: underline;
			text-underline-offset: -12px;
			text-decoration-skip-ink: none;
			text-underline-position: from-font;
		}
		.crossing {
			fill: white;
			stroke: none;
		}
		.junction {
			fill: green;
			stroke: none;
		}
		.resistorbody {
			fill: none;
			stroke-width: 3px;
			stroke: maroon;
		}
		.net:hover path {
			stroke: red;
		}
		.net:hover text {
			fill: red;
		}
		.net:hover .junction {
			fill: red;
		}
	</style>
	<g id=$dest>
	</g>
</svg>

<script>
	function attrxy(x, y) {
		return `x=${x*20} y=${y*20}`
	}
	function spacexy(x, y) {
		return `${x*20} ${y*20}`
	}
	function attrxy2(a, x, b, y) {
		return `${a}=${x*20} ${b}=${y*20}`
	}
	
	class Pin {
		constructor(desc, component) {
			if ('string'==typeof desc) {
				let m = /^(\d+) (\S+) (?:@(\d+),(\d+))?/.exec(desc)
				if (!m)
					throw new Error("invalid pin descriptor: “"+desc+"”")
				let [_,num,name,side,slot] = m
				this.name = name
				this.num = num
				side = +side | 0
				slot = +slot | 0
				while (component.used[side][slot])
					slot++
				component.used[side][slot] = true
				this.side = side
				this.slot = slot
			} else {
				Object.assign(this, desc)
			}
			this.calculate_position(component)
		}
		calculate_position(component) {
			this.r = {
				x: [this.slot,component.width,component.width-this.slot,0][this.side],
				y: [0,this.slot,component.height,component.height-this.slot][this.side],
				dir: ["v-20","h20","v20","h-20"][this.side],
				//diro: ["h-1l1,-1l1,1h-1v-10","v-3l3,3l-3,3v-3 h10","v10","h-10"][this.side],
			}
			this.e = {
				x: this.r.x + [0,1,0,-1][this.side],
				y: this.r.y + [-1,0,1,0][this.side],
			}
		}
		todesc() {
			return this.num+" "+this.name+" @"+this.side+","+this.slot
		}
	}
	
	class Component {
		constructor(obj) {
			let self = Object.setPrototypeOf(obj, Component.prototype)
			self.used = [[],[],[],[]]
			self.pins = self.pins.map(x=>new Pin(x, self))
			//self.pins2 = self.pins.map(x=>x.todesc())
			return self
		}
		render(placed) {
			let {name, override_name, displayname, suffix="", symbol:def, pos:{x, y}} = placed
			let s = ''
			let {width, height} = def
			if (def.body=='resistor') {
				s += `
<g class='chip resistor'>
<text ${attrxy(x, y-0.2)} class='name r'>${displayname || name}${suffix}</text>
<text ${attrxy(x+width, y-0.2)} class='desc'>${def.name||override_name} ${def.desc}</text>
<path d="M${spacexy(x,y)}h2l3,-6l6,12l6,-12l6,12l6,-12l6,12l3,-6h2" class='resistorbody'/>
`
			} else {
				s += `<g class=chip>`
				s += `<text ${attrxy(x+width/2, y-0.2)} class='desc c'>${def.name||override_name} ${def.desc}</text>`
				s += `<text ${attrxy(x+width/2, y-0.8)} class='name c'>${displayname || name}${suffix}</text>`
				s += `<rect class='body' ${attrxy(x, y)} ${attrxy2('width',width,'height',height)} />`
			}
			for (let p of def.pins) {
				let px = x + p.r.x
				let py = y + p.r.y
				//let dir = p.out ? p.r.diro : p.r.dir
				let dir = p.r.dir
				s += `<path class=pin d="m${spacexy(px,py)}${dir}" />`
				let pname = p.name
				let ext = ""
				if (pname[0]=="~") {
					// html/svg cannot render overlines properly
					//pname = `<tspan class=overline>${pname.slice(1)}</tspan>`
				}
				pname += suffix
				if (p.side==0) {
					s += `<text transform="translate(${spacexy(px, py+0.2)}) rotate(90)" class='pname m'>${p.name}</text>`
				} if (p.side==1) {
					s += `<text ${attrxy(px-0.2, py)} class='pname m r'>${pname}</text>`
					if (def.body!='resistor')
						s += `<text ${attrxy(px+0.2, py-0.2)} class=num>${p.num}</text>`
				} if (p.side==2) {
					s += `<text transform="translate(${spacexy(px, py-0.2)}) rotate(-90)" class='pname m'>${p.name}</text>`
				} if (p.side==3) {
					s += `<text ${attrxy(px+0.2, py)} class='pname m'>${pname}</text>`
					if (def.body!='resistor')
						s += `<text ${attrxy(px-0.2, py-0.2)} class='num r'>${p.num}</text>`
				}
				
			}
			return s + "</g>"
		}
	}
	
	let comps = {
		f74a: new Component({
			width: 3,
			height: 5,
			name: "74F74",
			desc: "D flip-flop",
			pins: [
				"1 ~CLR @3,1",
				"2 D @3,4",
				"3 CLK @3,3",
				"4 ~PRE @3,2",
				"5 Q @1,2",
				"6 ~Q @1,1",
			],
		}),
		f74b: new Component({
			width: 3,
			height: 5,
			name: "74F74",
			desc: "D flip-flop",
			pins: [
				"8 ~Q @1,1",
				"9 Q @1,2",
				"10 ~PRE @3,2",
				"11 CLK @3,3",
				"12 D @3,4",
				"13 ~CLR @3,1",
			],
		}),
		f161: new Component({
			width: 4,
			height: 12,
			name: "74F161",
			desc: "binary counter",
			pins: [
				"1 ~MR @3,1",
				"2 CLK @3,3",
				"3 D0 @3,11",
				"4 D1 @3,10",
				"5 D2 @3,9",
				"6 D3 @3,8",
				"7 ENP @3,5",
				
				"9 ~LOAD @3,6",
				"10 ENT @3,4",
				"11 Q3 @1,4",
				"12 Q2 @1,3",
				"13 Q1 @1,2",
				"14 Q0 @1,1",
				"15 RCO @1,10",
			],
		}),
		f163: new Component({
			width: 4,
			height: 12,
			name: "74F163",
			desc: "binary counter",
			pins: [
				"1 ~SR @3,1",
				"2 CLK @3,3",
				"3 D0 @3,11",
				"4 D1 @3,10",
				"5 D2 @3,9",
				"6 D3 @3,8",
				"7 ENP @3,5",
				
				"9 ~LOAD @3,6",
				"10 ENT @3,4",
				"11 Q3 @1,4",
				"12 Q2 @1,3",
				"13 Q1 @1,2",
				"14 Q0 @1,1",
				"15 RCO @1,10",
			],
		}),
		dpraml: new Component({
			width: 4,
			height: 16,
			name: "MB8421 L",
			desc: "dual-port RAM",
			pins: [
				"1 ~CS @3,3",
				"2 ~WE @3,2",
				"3 ~BUSY @1,12",
				"4 ~INT @1,13",
				
				"6 A10 @3,5",
				"7 ~OE @3,1",
				"8 A0 @3,15",
				"9 A1 @3,14",
				"10 A2 @3,13",
				"11 A3 @3,12",
				"12 A4 @3,11",
				"13 A5 @3,10",
				"14 A6 @3,9",
				"15 A7 @3,8",
				"16 A8 @3,7",
				"17 A9 @3,6",
				"18 IO0 @1,1",
				"19 IO1 @1,2",
				"20 IO2 @1,3",
				"21 IO3 @1,4",
				"22 IO4 @1,5",
				"23 IO5 @1,6",
				"24 IO6 @1,7",
				"25 IO7 @1,8",
			],
		}),
		f04: new Component({
			width: 3,
			height: 7,
			name: "74F04",
			desc: "inverter",
			pins: [
				"1 I1 @3,1",
				"2 ~Y1 @1,6",
				"3 I2 @3,2",
				"4 ~Y2 @1,5",
				"5 I3 @3,3",
				"6 ~Y3 @1,4",
				
				"8 ~Y4 @1,3",
				"9 I4 @3,4",
				"10 ~Y5 @1,2",
				"11 I5 @3,5",
				"12 ~Y6 @1,1",
				"13 I6 @3,6",
			],
		}),
		hc08c: new Component({
			width: 3,
			height: 3,
			name: "74HC08",
			desc: "AND gate",
			pins: [
				"8 Y @1,1",
				"9 A @3,2",
				"10 B @3,1",
			],
		}),
		osc: new Component({
			width:3,
			height: 2,
			desc: "oscillator",
			pins: [
				"8 CLK @1,1",
			],
		}),
		f244a: new Component({
			width: 3,
			height: 7,
			name: "74F244",
			desc: "line driver",
			pins: [
				"1 ~OE @3,1",
				"2 I0 @3,6",
				"4 I1 @3,5",
				"6 I2 @3,4",
				"8 I3 @3,3",
				"12 Y3 @1,4",
				"14 Y2 @1,3",
				"16 Y1 @1,2",
				"18 Y0 @1,1",
			],
		}),
		f244b: new Component({
			width: 3,
			height: 7,
			name: "74F244",
			desc: "line driver",
			pins: [
				"19 ~OE @3,1",
				"17 I0 @3,6",
				"15 I1 @3,5",
				"13 I2 @3,4",
				"11 I3 @3,3",
				"9 Y3 @1,4",
				"7 Y2 @1,3",
				"5 Y1 @1,2",
				"3 Y0 @1,1",
			],
		}),
		escd: new Component({
			width: 4,
			height: 3,
			name: "ES5701",
			desc: "Super-GLU",
			pins: [
				"10 16MI @3,1",
				"19 20MI @3,2",
				"8 8M @1,2",
				"21 10M @1,1",
			],
		}),
		r: new Component({
			width: 2,
			height: 0,
			name: "",
			desc: "",
			body: 'resistor',
			pins: [
				"1 &Tab; @3,0",
				"2 &Tab; @1,0",
			],
		}),
		r2: new Component({
			width: 2,
			height: 0,
			name: "",
			desc: "",
			body: 'resistor',
			pins: [
				"2 &Tab; @3,0",
				"1 &Tab; @1,0",
			],
		}),
	}
	
	let placed = [
		{
			name: "IC21A",
			displayname: "IC21:1",
			symbol: comps.f74a,
			pos: {x:12-5, y:11},
		},
		{
			name: "IC21B",
			displayname: "IC21:2",
			symbol: comps.f74b,
			pos: {x:19-5, y:11},
		},
		{
			name: "IC22",
			symbol: comps.f161,
			pos: {x:30-3-5, y:11-5},
		},
		{
			name: "IC30L",
			displayname: "IC30:L",
			symbol: comps.dpraml,
			pos: {x:35-5, y:10-5},
		},
		
		{
			name: "IC64A",
			symbol: comps.f74a,
			pos: {x:12, y:11+4+10},
		},
		{
			name: "IC64B",
			symbol: comps.f74b,
			pos: {x:19+2, y:11+5+10},
		},
		{
			name: "IC65",
			symbol: comps.f04,
			pos: {x:5, y:11+5+10},
		},
		
		{
			name: "IC19:B",
			symbol: comps.f74b,
			pos: {x:22-10-5, y:10+25+10},
		},
		{
			name: "IC19:A",
			symbol: comps.f74a,
			pos: {x:29-10-5, y:10+25+10},
		},
		{
			name: "X1",
			symbol: comps.osc,
			override_name: "26.686MHz",
			pos: {x:16-10-5, y:11+25+10},
		},
		{
			name: "IC20:A",
			symbol: comps.f244a,
			pos: {x:40-2-10-5, y:11+16+2+10-1},
		},
		{
			name: "IC20:B",
			symbol: comps.f244b,
			pos: {x:40-2-10-5, y:11+25+2+10},
		},
		{
			name: "X2",
			symbol: comps.osc,
			override_name: "30.47618MHz",
			pos: {x:16+10-10-5, y:11+20+10-1},
		},
		{
			name: "X3",
			symbol: comps.osc,
			override_name: "16MHz",
			pos: {x:16+5+10-10-5, y:11+15+3+10-1},
		},
		{
			name: "5701",
			displayname: "5701:clkdiv",
			symbol: comps.escd,
			pos: {x:31, y:37},
		},
		{
			name: "IC18",
			symbol: comps.f163,
			pos: {x:39, y:45},
		},
		{
			name: "IC1",
			displayname: "IC1:3",
			symbol: comps.hc08c,
			pos: {x:40, y:39},
		},
		{
			name: "R52",
			symbol: comps.r2,
			override_name: "82Ω",
			pos: {x:29, y:41},
		},
		{
			name: "R53",
			symbol: comps.r,
			override_name: "82Ω",
			pos: {x:29, y:42},
		},
		{
			name: "R54",
			symbol: comps.r2,
			override_name: "82Ω",
			pos: {x:29, y:51},
		},
		{
			name: "R55",
			symbol: comps.r,
			override_name: "82Ω",
			pos: {x:29, y:52},
		},
		{
			name: "R3",
			symbol: comps.r2,
			override_name: "2400Ω",
			pos: {x:12-4, y:19},
		},
	]
	
	let cons = [
		"IC22.D0 + IC22.D1 + IC22.D2 + IC22.D3 GND",
		
		"IC22.~LOAD VCC",
		"IC22.RCO NC",
		
		"IC21A.D +v-3h5 IC21A.~Q",
		"IC21B.D +v-3h5 IC21B.~Q",
		
		"ic21a.q +h1J ic21b.clk +Pv5h7v-3 ic22.clk",
		
		"IC22.Q0 + IC30L.A1",
		"IC22.Q1 + IC30L.A2",
		"IC22.Q2 + IC30L.A3",
		"IC22.Q3 + IC30L.A4",
		"IC21A.CLK =OTIS.E IC30L.1 =OTIS.E",
		
		"IC21A.~PRE GND",
		"IC21B.~PRE GND",
		"<circle cx=240 cy=340 r=3 class=crossing />",
		"<circle cx=380 cy=340 r=3 class=crossing />",
		
		"ic21a.~clr =OTIS.BS +v2Jh7J ic21b.~clr +P ic22.~mr +Pv2h1 r3.2",
		"r3.1 GND",
		
		"ic21b.q +h2J ic22.enp +PJv1h1 ic22.ent +Pv-9h8v2 ic30l.a0",
		
		"ic30l.a5 + ic30l.a6 + ic30l.a7 + ic30l.a8 + ic30l.a9 + ic30l.a10 + GND",
		
		"IC30L.IO4 NC",
		"IC30L.IO5 NC",
		"IC30L.IO6 NC",
		"IC30L.IO7 NC",
		
		"IC30L.IO0 =cartB.89",
		"IC30L.IO1 =cartB.90",
		"IC30L.IO2 =cartB.91",
		"IC30L.IO3 =cartB.92",
		
		"IC30L.~OE GND",
		
		"IC30L.~BUSY =(pulldown?)", // unsure
		"IC30L.~WE GND",
		"IC30L.4 NC",
		
		"IC65.13 =FDP.205",
		"IC65.12 + IC64A.3",
		"IC65.11 =CPU.AS",
		"IC65.10 +h1J IC64A.4 +Pv3h6v-2 IC64B.10",
		"IC64A.5 + IC64B.12",
		"IC64B.9 =FCM.109",
		"IC64B.11 =~VRAM-CE", //], /*"h-10 v60 h-100"*/""],
		
		"IC64A.1 VCC",
		"IC64A.2 GND",
		"IC64B.13 VCC",
		"IC64A.~Q NC",
		"IC64B.~Q NC",
		
		"IC19:B.D +v-3h5 IC19:B.~Q",
		"IC19:B.Q +h1J IC19:A.CLK +Pv4h9J IC20:B.I2 +Pv-10 IC20:A.I2",
		"IC20:B.I0 +h-1Gh-3v2Gv2h-1 =FDP.120",
		"IC19:A.~Q +Jv-3h-5 IC19:A.D +Ph3Gh10 =~VCLK_7",
		"IC19:B.~PRE IC19:B.~CLR GND",
		"IC19:A.~PRE IC19:A.~CLR GND",
		"IC19:A.Q +h2Jv-1Gv-4h1G IC20:A.I3 +Pv2Gv2Gv1 IC20:B.I3",
		"X1.CLK + IC19:B.CLK",
		
		"IC20:A.~OE GND",
		"IC20:B.~OE GND",
		"IC20:B.I1 GND",
		
		"X3.CLK + IC20:A.I0",
		"X2.CLK +h5v-1 IC20:A.I1",
		
		/*"IC20:A.18 5701.10",
		"IC20:A.16 +h1J 5701.19 +Pv-1Gv-3h8 =CLK_30",
		"IC20:B.5 NC",
		"IC20:B.3 =VSYNC",*/
		"ic20:A.14 + r52.2",
		"r52.1 =VCLK_13",
		"ic20:A.12 + r53.1",
		"r53.2 =VCLK_7",
		
		"ic20:B.7 + r54.2",
		"r54.1 =cartC.1",
		"ic20:B.9 + r55.1",
		"r55.2 =cartC.2",
		
		"ic20:B.3 =V_SYNC",
		
		"ic20:A.16 +h2v-2J 5701.19 +Pv-3h6 =CLK_30",
		"ic20:A.18 +h2G 5701.10",
		
		"ic20:B.5 NC",
		"5701.21 +h2Jv3 ic1.10 +Pv-2h1 =CLK_15",
		"ic1.8 =CPU.CLK",
		
		"ic18.3 + ic18.4 + ic18.5 + ic18.6 GND",
		"ic18.1 VCC",
		"ic18.10 + ic18.7 + ic18.9 VCC",
		"ic18.15 NC",
		"5701.8 +h1v4Jv11 ic18.2 +Ph7 =CLK_8",
		"ic18.14 =CLK_4",
		"ic18.12 =CLK_1",
		"ic18.11 =CLK_05",
		"ic1.9 VCC",
	]
	
	let byname = {}
	for (let p of placed)
		byname[p.name] = p
	
	function lookup_pin(des) {
		let [part,pin] = des.split(".")
		if (!part || !pin)
			return [null, null]
		part = part.toUpperCase()
		pin = pin.toUpperCase()
		part = byname[part]
		if (!part)
			return [null, null]
		pin = part.symbol.pins.find(x=>(x.num==pin||x.name==pin))
		return [part, pin]
	}
	function draw_conn2(desc) {
		desc = desc.split(" ")
		let s = ""
		let s2 = "", s1=""
		let px = 0
		let py = 0
		let dir = 0
		let landmarks = []
		let lineto = (c)=>{s+=c+spacexy(px,py)}
		let drawing = false
		let label = null
		function add_label(text) {
			if (dir==3)
				s2 += `<text ${attrxy(px-0.2, py)} class='netlabel m r'>${text}</text>`
			else 
				s2 += `<text ${attrxy(px+0.2, py)} class='netlabel m l'>${text}</text>`
		}
		for (let item of desc) {
			if (item[0]=="+") {
				for (let move of item.slice(1).matchAll(/[a-zA-Z][^a-zA-Z]*/g)) {
					move = move[0]
					let num = +move.slice(1)
					if (move[0]=="h") {
						px += num
						dir = num < 0 ? 3 : 1
						lineto('L')
					} else if (move[0]=='v') {
						py += num
						dir = num < 0 ? 0 : 2
						lineto('L')
					} else if (move[0]=='J') {
						landmarks.push([px,py])
						s2 += `<circle ${attrxy2('cx',px,'cy',py)} r=3 class=junction />`
					} else if (move[0]=='P') {
						0,[px,py] = landmarks.pop()
						lineto('M')
					} else if (move[0]=='G') {
						s1 += `<circle ${attrxy2('cx',px,'cy',py)} r=3 class=crossing />`
					} else {
						throw new Error('oh no +'+move[0])
					}
				}
				drawing = true
			} else if (item[0]=="=") {
				label = item.slice(1)
				add_label(label)
				drawing = false
			} else {
				if (item=="VCC") {
					s += `v-6 h-2 l2,-6 l2,6 h-2 v-6`
				} else if (item=="GND") {
					s += `v6 h-6 l6,6 l6,-6 h-6`
				} else if (item=="NC") {
					s += `m-4,-4 l8,8 m0-8 l-8,8`
				} else {
					let [part, pin] = lookup_pin(item)
					if (!part || !pin) {
						throw new Error("lookup pin failed: “"+item+"”")
						add_label(item)
						drawing = false
					} else {
						dir = pin.side
						px = pin.e.x+part.pos.x
						py = pin.e.y+part.pos.y
						if (drawing)
							lineto('L')
						else {
							lineto('M')
						}
					}
				}
				drawing = false
			}
		}
		return "<g class=net>"+s1+`<path d="`+s+`"/>`+s2+"</g>"
	}
	let s = ''
	for (let p of placed) {
		byname[p.name] = p
		s += p.symbol.render(p)
	}
	s += "<g stroke=green stroke-width=2px fill=none>"
	for (let conn of cons) {
		if (conn[0]=="<")
			s+=conn
		else
			s += draw_conn2(conn)
	}
	s += "</g>"
	$dest.innerHTML = s
</script>
