<!doctype html><meta charset=utf-8>

<svg xmlns=http://www.w3.org/2000/svg viewBox="-10 0 1000 3000" width=1000>
	<style>
		@font-face {
			font-family: 'mspm';
			src: url("./short2.otf?1");
		}
		:root {
			font-family: mspm, serif;
		}
		.l { text-anchor: start; }
		.c { text-anchor: middle; }
		.r { text-anchor: end; }
		.t { dominant-baseline: hanging; }
		.m { dominant-baseline: central; }
		.b { dominant-baseline: auto; }
		.body {
			fill: beige;
			stroke: maroon;
			stroke-width: 4px;
		}
		.discretebody {
			fill: none;
			stroke-width: 2px;
			stroke: maroon;
		}
		.pin {
			stroke: maroon;
			stroke-width: 4px;
			stroke-linecap: round;
		}
		.name {
			font-size: 16px;
			font-weight: bold;
		}
		.desc {
			font-size: 12px;
		}
		.discrete .name {
			font-size: 14px;
		}
		.discrete .desc {
		}
		.pname {
			font-size: 14px;
			fill: black;
		}
		.num {
			font-size: 12px;
			fill: #008;
		}
		.netlabel {
			stroke: none;
			fill: blue;
			font-size: 16px;
		}
		.overline {
			text-decoration: underline;
			text-underline-offset: -12px;
			text-decoration-skip-ink: none;
			text-underline-position: from-font;
		}
		.crossing {
			fill: white;
			stroke: none;
		}
		.junction {
			fill: green;
			stroke: none;
		}
		.net:hover path {
			stroke: red;
		}
		.net:hover text {
			fill: red;
		}
		.net:hover .junction {
			fill: red;
		}
	</style>
	<g id=$dest>
	</g>
</svg>

<script src=lib.js></script>
<script src=components.js></script>
<script src=placed.js></script>
<script>
	let byname = {}
	for (let p of placed)
		byname[p.name] = p
	
	function lookup_pin(des) {
		let [part,pin] = des.split(".")
		if (!part || !pin)
			return [null, null]
		part = part.toUpperCase()
		pin = pin.toUpperCase()
		part = byname[part]
		if (!part)
			return [null, null]
		pin = part.symbol.pins.find(x=>(x.num==pin||x.name==pin))
		return [part, pin]
	}
	function draw_conn2(desc) {
		desc = desc.split(" ")
		let s = ""
		let s2 = "", s1=""
		let px = 0
		let py = 0
		let dir = 0
		let landmarks = []
		let lineto = (c)=>{s+=c+spacexy(px,py)}
		let drawing = false
		let label = null
		function add_label(text) {
			if (dir==3)
				s2 += `<text ${attrxy(px-0.2, py)} class='netlabel m r'>${text}</text>`
			else if (dir==0)
				s2 += `<text transform="translate(${spacexy(px, py-0.2)}) rotate(-90)" class='netlabel m'>${text}</text>`
			else 
				s2 += `<text ${attrxy(px+0.2, py)} class='netlabel m l'>${text}</text>`
		}
		for (let item of desc) {
			if (item[0]=="+") {
				for (let move of item.slice(1).matchAll(/[a-zA-Z][^a-zA-Z]*/g)) {
					move = move[0]
					let num = +move.slice(1)
					if (move[0]=="h") {
						px += num
						dir = num < 0 ? 3 : 1
						lineto('L')
					} else if (move[0]=='v') {
						py += num
						dir = num < 0 ? 0 : 2
						lineto('L')
					} else if (move[0]=='J') {
						landmarks.push([px,py])
						s2 += `<circle ${attrxy2('cx',px,'cy',py)} r=3 class=junction />`
					} else if (move[0]=='P') {
						0,[px,py] = landmarks.pop()
						lineto('M')
					} else if (move[0]=='G') {
						s1 += `<circle ${attrxy2('cx',px,'cy',py)} r=3 class=crossing />`
					} else {
						throw new Error('oh no +'+move[0])
					}
				}
				drawing = true
			} else if (item[0]=="=") {
				label = item.slice(1)
				add_label(label)
				drawing = false
			} else {
				if (item=="VCC") {
					s += `v-6 h-2 l2,-6 l2,6 h-2 v-6`
				} else if (item=="GND") {
					s += `v6 h-6 l6,6 l6,-6 h-6`
				} else if (item=="NC") {
					s += `m-4,-4 l8,8 m0-8 l-8,8`
				} else {
					let [part, pin] = lookup_pin(item)
					if (!part || !pin) {
						throw new Error("lookup pin failed: “"+item+"”")
						add_label(item)
						drawing = false
					} else {
						dir = pin.side
						px = pin.e.x+part.pos.x
						py = pin.e.y+part.pos.y
						if (drawing)
							lineto('L')
						else {
							lineto('M')
						}
					}
				}
				drawing = false
			}
		}
		return "<g class=net>"+s1+`<path d="`+s+`"/>`+s2+"</g>"
	}
	let s = ''
	for (let p of placed) {
		byname[p.name] = p
		s += p.symbol.render(p)
	}
	s += "<g stroke=green stroke-width=2px fill=none>"
	for (let conn of cons) {
		if (conn[0]=="<")
			s+=conn
		else
			s += draw_conn2(conn)
	}
	s += "</g>"
	$dest.innerHTML = s
</script>
